
# set selinux to permissive in /etc/sysconfig/selinux


yum install -y mysql-server php php-mysql httpd mod_ssl

chkconfig mysqld on
chkconfig httpd on
service mysqld start
service httpd start

#secure mysql server accounts by creating passwords
/usr/bin/mysqladmin -u root password 'new-password'
/usr/bin/mysqladmin -u root -p -h migrate.schoolname.edu password 'new-password'

#Remove anonymous accounts that have access to the "Test" database
mysql -u root -p
	mysql> DELETE FROM mysql.user WHERE User = '';
	mysql> FLUSH PRIVILEGES;

# append the following to /etc/sysconfig/iptables to open https port in the firewall
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT

# restart the firewall
service iptables restart

--------------------------------------------------------------------------

# install phpmyadmin
cd ~
wget http://superb-east.dl.sourceforge.net/sourceforge/phpmyadmin/phpMyAdmin-2.11.9.4-english.tar.gz
tar xzvf phpMyAdmin-2.11.9.4-english.tar.gz
mv phpMyAdmin-2.11.9.4-english /var/www/html/phpmyadmin
rm phpMyAdmin-2.11.9.4-english.tar.gz
cp /var/www/html/phpmyadmin/config.sample.inc.php /var/www/html/phpmyadmin/config.inc.php

# set the blowfish_secret to a random string of characters in /var/www/html/phpmyadmin/config.inc.php

--------------------------------------------------------------------------

# login to phpmyadmin with root and password
# create the "migrate" database and a "migrate" user with a password "test" that can "Select, Insert, Update, Delete" on the "migrate" database

# use the usermap.sql file to create the usermap table and fields
mysql -u root -p migrate < usermap.sql


--------------------------------------------------------------------------

# install dag wieers rpmforge yum repository information so you can get the perl modules needed for the migration script
wget http://dag.wieers.com/rpm/packages/rpmforge-release/rpmforge-release-0.3.6-1.el5.rf.i386.rpm
rpm -Uvh rpmforge-release-0.3.6-1.el5.rf.i386.rpm 
rm rpmforge-release-0.3.6-1.el5.rf.i386.rpm


# install perl modules needed for the migration script
yum install -y perl-List-Compare perl-Hash-Case perl-Date-Manip perl-Email-Send perl-Object-Realize-Later perl-Mail-Box perl-Mail-IMAPClient perl-MIME-Types perl-TimeDate


# patch the perl List::Compare module so it can do case insensitive comparisons
# go to the directory that has the "list-compare-case-insensitive.patch" patch file
patch -b -d /usr/lib/perl5/vendor_perl/5.8.8/List/ < list_compare_case_insensitive.patch

--------------------------------------------------------------------------

# create a place to store migration logs
mkdir /var/log/migration

--------------------------------------------------------------------------

# replace sendmail with postfix
yum install -y postfix

# configure postfix
postconf -e 'inet_interfaces = all'
postconf -e 'mynetworks = 127.0.0.0/8'
postconf -e 'myhostname = migrate.schoolname.edu'
postconf -e 'home_mailbox = Maildir/'
postconf -e 'mailbox_command ='
postconf -e 'mailbox_size_limit = 512000000'
postconf -e 'message_size_limit = 102400000'

# stop sendmail and start postfix
chkconfig sendmail off
chkconfig postfix on
service sendmail stop
service postfix start

# append the following to /etc/sysconfig/iptables to open smtp port in the firewall
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 25 -j ACCEPT

# restart the firewall
service iptables restart

# update logwatch's postfix parsing script
cd ~
wget http://www.mikecappella.com/logwatch/release/postfix-logwatch-1.37.08.tgz
tar xzvf postfix-logwatch-1.37.08.tgz
cd postfix-logwatch-1.37.08
make install-logwatch
cd ~
rm -r postfix-logwatch*

--------------------------------------------------------------------------

# create a "migrate" user who's mailbox will be used to send and receive scripted migration emails
useradd -s /sbin/nologin migrate


# make the necessary folders for filtered email
# the rest of the maildir folders will get automatically created by procmail as email is filtered into them
mkdir -p /home/migrate/Maildir/{cur,new,tmp}
chown -R migrate:migrate /home/migrate/Maildir/
chmod -R 700 /home/migrate/Maildir/


# forward all email sent to "migrate@migrate.schoolname.edu" to procmail for further processing
cat > /home/migrate/.forward <<EOF
|/usr/bin/procmail
EOF


# create a .procmailrc file for the migrate user that will filter email into appropriate folders
cat > /home/migrate/.procmailrc <<EOF
##Begin Filter Configuration

LOGFILE=\$HOME/.procmail.log
DEFAULT=\$HOME/Maildir/

# Default mail directory
MAILDIR=\$HOME/Maildir/

:0
* ^Return-Path: <migrate@migrate.schoolname.edu>
{
        :0
        * ^Subject:.*BA Migrate Script 1:
        .ba_sent_1/

        :0
        * ^Subject:.*BA Migrate Script 2:
        .ba_sent_2/

        :0
        * ^Subject:.*BA Migrate Script 3:
        .ba_sent_3/

        :0
        * ^Subject:.*BA Migrate Script 4:
        .ba_sent_4/

        :0
        * ^Subject:.*BA Migrate Script 5:
        .ba_sent_5/

        :0
        * ^Subject:.*BA Migrate Script 6:
        .ba_sent_6/

        :0
        * ^Subject:.*BA Migrate Script 7:
        .ba_sent_7/

        :0
        * ^Subject:.*BA Migrate Script 8:
        .ba_sent_8/

        :0
        * ^Subject:.*BA Migrate Script Usermap:
        .build_usermap_sent/

        :0
        * ^Subject:.*BA Migrate Script switched_user:
        .switched_user_sent/
}

:0
* ^Return-Path: <administrator@schoolname.edu>
{
        :0
        * ^Subject:.*BA Migrate Script 1:
        .ba_rcvd_1/

        :0
        * ^Subject:.*BA Migrate Script 2:
        .ba_rcvd_2/

        :0
        * ^Subject:.*BA Migrate Script 3:
        .ba_rcvd_3/

        :0
        * ^Subject:.*BA Migrate Script 4:
        .ba_rcvd_4/

        :0
        * ^Subject:.*BA Migrate Script 5:
        .ba_rcvd_5/

        :0
        * ^Subject:.*BA Migrate Script 6:
        .ba_rcvd_6/

        :0
        * ^Subject:.*BA Migrate Script 7:
        .ba_rcvd_7/

        :0
        * ^Subject:.*BA Migrate Script 8:
        .ba_rcvd_8/

        :0
        * ^Subject:.*BA Migrate Script Usermap:
        .build_usermap_rcvd/

        :0
        * ^Subject:.*BA Migrate Script switched_user:
        .switched_user_rcvd/
}

##End Filter Configuration
EOF

# set proper ownership on everything in the migrate user's home directory
chown -R migrate:migrate /home/migrate

--------------------------------------------------------------------------

# now you're system is ready to run the migration script

